version: '3.8'

services:
  # Servicio de la Base de Datos PostgreSQL
  db:
    image: postgres:15
    container_name: tractor_db
    restart: always
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: 1234
      POSTGRES_DB: tractor
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      # Expone el puerto 5433 de tu PC al 5432 de Docker (para DBeaver)
      - "5433:5432"

  # Servicio del Backend (Tu API de FastAPI)
  backend:
    build:
      context: ./backend # 1. Busca el Dockerfile en la carpeta 'backend'
    container_name: tractor_api
    restart: always
    ports:
      - "8000:8000" # 2. Expone tu API en el puerto 8000
    volumes:
      - ./backend:/app # 3. Monta tu código local para hot-reload
    env_file:
      - ./backend/.env
    depends_on:
      - db
    environment:
      DATABASE_URL: "postgresql://postgres:1234@db/tractor"

  # Servicio del Frontend (Tu App de React en MODO DESARROLLO)
  frontend:
    # 4. NO usamos 'build'. Usamos una imagen de Node directa.
    image: node:20-alpine
    container_name: tractor_frontend_dev
    restart: always
    ports:
      # 5. 5173 es el puerto por defecto de VITE (npm run dev)
      - "5173:5173"
    volumes:
      - ./frontend:/app # 6. Mapea tu código de frontend
      - /app/node_modules # 7. Truco para no sobrescribir node_modules
    working_dir: /app
    environment:
      # 8. Necesario para que el hot-reload funcione en Docker
      - CHOKIDAR_USEPOLLING=true
    # 9. Comando para instalar y correr el servidor de desarrollo
    command: sh -c "npm install && npm run dev -- --host"
    depends_on:
      - backend # 10. No inicies el frontend hasta que el backend esté listo

volumes:
  # Volumen persistente para los datos de Postgres
  postgres_data:
